name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version"
        default: "E.g. 4.0.0"
        required: true
      next:
        description: "Next version"
        default: "E.g. 5.0.0-SNAPSHOT"
        required: false

jobs:
  prepare:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-java@v3
        with:
          java-version: 17
          distribution: temurin
          cache: maven
      - name: Set release version ${{ github.event.inputs.version }}
        run: |
          mvn -B versions:set versions:commit -DnewVersion=$NEW_VERSION
        env:
          NEW_VERSION: ${{ github.event.inputs.version }}
      - name: Commit and Push
        uses: carlosthe19916/release-tools/.github/actions/commit@main
        with:
          commit_message: "üèÅ Releasing version ${{ github.event.inputs.version }}"
          branch: main

  release:
    needs: [ prepare ]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          ref: main
          fetch-depth: 0
      - uses: actions/setup-java@v3
        with:
          java-version: 17
          distribution: temurin
          cache: maven
      - name: JReleaser - release
        uses: jreleaser/release-action@v2
        env:
          JRELEASER_GITHUB_TOKEN: ${{ secrets.GH_PAT }}
          JRELEASER_PROJECT_VERSION: ${{ github.event.inputs.version }}
          JRELEASER_PRERELEASE_PATTERN: .*(?:Alpha|alpha|Beta|beta)[0-9]
      - name: JReleaser - generate log
        if: always()
        shell: bash
        run: tar -czvf jreleaser-log.tgz out/
      - name: JReleaser - upload log
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: jreleaser-log
          path: 'jreleaser-log.tgz'
      - name: Set version ${{ github.event.inputs.next }}
        run: |
          mvn -B versions:set versions:commit -DnewVersion=$NEW_VERSION
        env:
          NEW_VERSION: ${{ github.event.inputs.next }}
      - name: Commit and Push
        uses: carlosthe19916/release-tools/.github/actions/commit@main
        with:
          commit_message: "‚¨ÜÔ∏è Next version ${{ github.event.inputs.next }}"
          branch: main
